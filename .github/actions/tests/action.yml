name: "Run Tests & Coverage"
description: "Compile, run JUnit tests and generate coverage report with JaCoCo"

runs:
  using: "composite"
  steps:

    # … pasos previos: setup-java, compile, descargar junit …

    - name: Descargar JaCoCo
      shell: bash
      run: |
        mkdir -p libs
        curl -L -o lib/jacocoagent.jar \
             https://repo1.maven.org/maven2/org/jacoco/org.jacoco.agent/0.8.10/org.jacoco.agent-0.8.10-runtime.jar
        curl -L -o lib/jacococli.jar \
             https://repo1.maven.org/maven2/org/jacoco/org.jacoco.cli/0.8.10/org.jacoco.cli-0.8.10-nodeps.jar

    - name: Ejecutar tests con cobertura
      shell: bash
      run: |
        # inyectamos el agente con destfile=coverage.exec
        java -javaagent:lib/jacocoagent.jar=destfile=coverage.exec \
             -jar lib/junit-platform-console-standalone.jar \
             --classpath out --scan-classpath

    - name: Generar reporte JaCoCo
      shell: bash
      run: |
        mkdir -p coverage-report
        java -jar lib/jacococli.jar report coverage.exec \
             --classfiles out \
             --sourcefiles src/flappybird \
             --html coverage-report \
             --xml coverage-report/coverage.xml

    - name: Publicar reporte de cobertura
      uses: actions/upload-artifact@v4
      with:
        name: cobertura-report
        path: coverage-report
